# CQRS

## 11.1 단일 모델의 단점

조회 화면 특성상 조회 속도가 빠를수록 좋은데 여러 애그리거트의 데이터가 필요하면 구현 방법을 고민해야 한다.

식별자를 이용해서 애그리거트를 참조하는 방식을 사용하면 즉시 로딩방식과 같은 JPA의 쿼리 관련 최적화 기능을 사용할 수 없다. (이는 조회 성능에 문제가 생길 수 있다)

또한 애그리거튼 간 연관을 식별자가 아니라 직접 참조하는 방식으로 연결해도 고민거리가 생긴다. 조회 화면 특성에 따라 같은 연관도 즉시 로딩이나 지연 로딩으로 처리해야 하기 때문이다.
조회 기능을 구현할 때 DBMS가 제공하는 전용 기능이 필요하면 JPA의 네이티브 쿼리를 사용해야 할 수도 있다.

이러한 문제가 발생하는 이유는 시스템 상태를 변경할 때와 조회할 때 단일 도메인 모델을 사용하기 때문이다.

객체 지향으로 도메인 모델을 구현할 때 주로 사용하는 ORM 기법은 Order#cancel(), Order#changeShippingInfo() 기능처럼 도메인 상태 변경 기능을 구현하는 데는 적합하지만 주문 상세 조회 화면처럼 여러 애그리거트에서 데이터를 가져와 출력하는 기능을 구현하기에는 고려할 게 많아서 구현을 복잡하게 만드는 원인이 된다.

이런 구현 복잡도를 낮추는 간단한 방법이 있는데 그것은 바로 상태 변경을 위한 모델과 조회를 위한 모델을 분리하는 것이다.

## 11.2 CQRS

시스템이 제공하는 기능은 크게 두 가지로 나눌 수 있다.

1. 상태를 변경하는 기능
2. 상태 정보를 조회하는 기능

도메인 모델 관점에서 상태 변경 기능은 주로 한 애그리거트의 상태를 변경한다. 반면에 조회 기능에 필요한 데이터를 표시하려면 두 개 이상의 애그리거트가 필요할 때가 많다.

이러한 문제를 해결하기 위해 사용하는 방법이 CQRS이다.

![11.2](https://user-images.githubusercontent.com/66859363/210959134-faa13847-5746-41fe-ae8e-c2397eb23c6e.png)

CQRS는 Command Query Responsibility Segregation의 약자로 `상태를 변경하는 명령을 위한 모델`과 `상태를 제공하는 조회를 위한 모델`을 분리하는 패턴이다.

CQRS는 복잡한 도메인에 적합하다. 도메인이 복잡할수록 명령 기능과 조회 기능이 다루는 데이터 범위가 차이가 난다.

예를 들어 온라인 쇼핑에서 다양한 차원에서 주문/판매/ 통계를 조회해야 한다고 해보자. JPA 기반 단일 도메인 모델을 사용하면 통계 값을 빠르게 조회하기 위해 JPA와 관련된 다양한 성능 관련 기능을 모델에 적용해야 한다. 이런 도메인에 CQRS를 적용하면 통계를 위한 조회 모델을 별도로 만들기 때문에 조회 기능 때문에 도메인 모델이 복잡해지는 것을 막을 수 있다.

또한 각 모델에 맞는 구현 기술을 선택할 수 있다.

![11.3](https://user-images.githubusercontent.com/66859363/210959152-6a3e48a5-8d0b-4109-95a0-296b054eee09.png)

![11.5](https://user-images.githubusercontent.com/66859363/210959143-c3968cd1-3ff2-4a46-80a2-82acd79bdbed.png)

위와 같이 명령 모델은 RDBMS로 조회 모델은 NoSQL로 구현가능하다.

### 11.2.1 웹과 CQRS

일반적인 웹 서비스는 상태를 변경하는 요청보다 상태를 조회하는 요청이 많다.

그렇기 때문에 개발팀은 조회 성능을 높이기 위해 다양한 기법을 사용한다. 기본적으로 쿼리를 최적화해서 쿼리 실행 속도 자체를 높이고, 메모리에 조회 데이터를 캐싱해서 응답 속도를 높이기도 한다. 조회 전용 저장소를 따로 사용하기도 한다.

이렇게 조회 성능을 높이기 위해 다양한 기법을 사용하는 것은 결과적으로 CQRS를 적용하는 것과 같은 효과를 만든다.

### 11.2.2 CQRS 장단점

#### 장점

+ 명령 모델을 구현할 때 도메인 자체에 집중할 수 있다.
+ 조회 성능을 향상시키는 데 유리하다

#### 단점

+ 구현해야 할 코드가 더 많다.
+ 더 많은 구현 기술이 필요하다.

이러한 장단점을 고려해서 CQRS 패턴을 도입할지 여부를 결정해야 한다.

도메인이 복잡하지 않은데 CQRS를 도입하면 두 모델을 유지하는 비용만 높아지고 얻을 수 있는 이점은 없다.

반면에 트래픽이 높은 서비스인데 단일 모델을 고집하면 유지 보수 비용이 오히려 높아질 수 있으므로 CQRS 도입을 고려하자.
